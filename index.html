<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NMS // SINGULARITY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  
  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --nms-blue: #44c7ff;
      --nms-dark-blue: #0b1e2d;
      --nms-orange: #ff9d00;
      --nms-red: #ff3a3a;
      --nms-white: #f0f8ff;
      --nms-glass: rgba(12, 24, 36, 0.90);
      --nms-border: rgba(68, 199, 255, 0.4);
      --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
      --font-stack: "Century Gothic", "Futura", "Trebuchet MS", sans-serif;
    }

    /* --- RESET & BASE --- */
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    html, body { 
      height: 100%; margin: 0; overflow: hidden; 
      background: #000; color: var(--nms-white);
      font-family: var(--font-stack);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    /* --- BOOT SEQUENCE --- */
    #boot-screen {
      position: fixed; inset: 0; z-index: 99999;
      background: #fff; color: #000;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      animation: fadeOut 0.5s ease-in-out 2.5s forwards;
      pointer-events: none;
    }
    .boot-logo { font-size: 48px; font-weight: 900; letter-spacing: 10px; animation: zoomIn 2s ease-out; }
    .boot-sub { font-size: 12px; margin-top: 20px; animation: pulse 0.5s infinite; }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* --- FX LAYERS --- */
    #hex-canvas { position: fixed; inset: 0; z-index: -2; opacity: 0.4; }
    .vignette { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, transparent 40%, #000 120%); }
    .scanlines {
      position: fixed; inset: 0; z-index: 9990; pointer-events: none;
      background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
      mix-blend-mode: overlay;
    }

    /* --- LAYOUT --- */
    #tilt-wrapper {
      height: 100%; width: 100%;
      overflow-y: auto; scrollbar-width: none;
      perspective: 1000px;
    }
    #tilt-wrapper::-webkit-scrollbar { display: none; }
    
    .container {
      max-width: 1280px; margin: 0 auto; padding: 20px;
      transform-style: preserve-3d; transition: transform 0.1s linear;
    }

    /* --- HUD --- */
    .hud {
      display: flex; justify-content: space-between; align-items: flex-end;
      border-bottom: 2px solid rgba(255,255,255,0.2);
      padding-bottom: 10px; margin-bottom: 20px; position: relative;
    }
    .hud::after {
      content:""; position:absolute; bottom:-2px; left:0; width:200px; height:2px; background:var(--nms-orange);
      box-shadow: 0 0 10px var(--nms-orange);
    }
    .title h1 { margin: 0; font-size: 32px; font-weight: 900; text-shadow: 2px 0 0 rgba(255,0,0,0.5), -2px 0 0 rgba(0,255,255,0.5); }
    .subtitle { color: var(--nms-blue); font-size: 12px; font-weight: bold; margin-top: 4px; display: block; }
    
    /* --- PANELS --- */
    .panel {
      background: var(--nms-glass); border: 1px solid var(--nms-border);
      padding: 4px; margin-bottom: 20px;
      clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
    }
    .panel-content {
      border: 1px solid rgba(255,255,255,0.1); padding: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      clip-path: polygon(18px 0, 100% 0, 100% calc(100% - 18px), calc(100% - 18px) 100%, 0 100%, 0 18px);
    }
    .panel-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .panel-head h2 { margin: 0; font-size: 14px; color: var(--nms-orange); display: flex; align-items: center; gap: 10px; }
    .step-deco { width: 20px; height: 6px; background: var(--nms-orange); clip-path: polygon(0 0, 100% 0, 80% 100%, 0 100%); }

    /* --- INPUTS & TOOLS --- */
    .toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
    .tool-btn {
      background: rgba(255,255,255,0.1); border: none; color: #fff;
      width: 32px; height: 32px; cursor: pointer; display: grid; place-items: center;
    }
    .tool-btn:hover { background: var(--nms-blue); color: #000; }
    .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    input[type="text"], select {
      width: 100%; background: rgba(0,0,0,0.5); border: none; border-bottom: 2px solid #3a4b5c;
      color: #fff; padding: 12px; font-family: inherit; font-size: 16px; letter-spacing: 2px; text-transform: uppercase;
    }
    input[type="text"]:focus { background: rgba(68, 199, 255, 0.1); border-bottom-color: var(--nms-blue); outline: none; }
    
    /* --- PREVIEW & WIDTH BAR --- */
    .preview-wrapper { position: relative; background: #05080c; border: 1px solid #333; margin-bottom: 10px; }
    .preview-box {
      min-height: 100px; display: flex; align-items: center; justify-content: center;
      font-size: 24px; font-weight: 900; white-space: nowrap; overflow: hidden;
    }
    .width-bar { height: 4px; background: #333; width: 100%; position: absolute; bottom: 0; left: 0; }
    .width-fill { height: 100%; background: var(--nms-blue); width: 0%; transition: width 0.3s, background 0.3s; }
    .width-warn { position: absolute; bottom: 6px; right: 6px; font-size: 10px; color: #666; }

    /* --- DRAG & DROP SLOTS --- */
    .slot-container {
      display: flex; flex-wrap: wrap; gap: 8px;
      background: rgba(0,0,0,0.3); padding: 10px; border: 1px dashed #445566;
      min-height: 60px; align-items: center;
    }
    .slot {
      width: 48px; height: 48px; background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1); cursor: grab;
      display: grid; place-items: center; position: relative;
      transition: transform 0.2s, border-color 0.2s;
    }
    .slot:hover { border-color: var(--nms-blue); background: rgba(68,199,255,0.1); }
    .slot.dragging { opacity: 0.5; border-color: var(--nms-orange); transform: scale(0.9); }
    .slot-img { font-size: 24px; pointer-events: none; }
    .slot-add { color: #555; font-size: 20px; pointer-events: none; }
    .word-chip { 
      padding: 0 12px; height: 32px; display: flex; align-items: center;
      background: #0b1e2d; border-left: 2px solid var(--nms-orange);
      font-weight: bold; color: #ccc; font-size: 12px;
    }

    /* --- TABS --- */
    .tab-rail { display: flex; gap: 4px; margin-bottom: 20px; overflow-x: auto; }
    .tab {
      flex: 1; padding: 12px 0; background: rgba(255,255,255,0.05);
      border: none; color: #888; font-family: inherit; font-weight: bold; font-size: 12px;
      cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%);
      min-width: 100px;
    }
    .tab.active { background: var(--nms-white); color: #000; }

    /* --- HOLD BTN --- */
    .hold-btn {
      position: relative; width: 100%; height: 48px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
      color: #fff; font-weight: bold; letter-spacing: 2px;
      display: flex; align-items: center; padding-left: 54px; cursor: pointer;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .hold-btn:hover { background: rgba(255,255,255,0.1); }
    .hold-ring { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; }
    .hold-svg { width: 32px; height: 32px; transform: rotate(-90deg); }
    .hold-bg { fill: none; stroke: #333; stroke-width: 3; }
    .hold-prog { fill: none; stroke: var(--nms-white); stroke-width: 3; stroke-dasharray: 88; stroke-dashoffset: 88; }

    /* --- DIALOG --- */
    dialog { background: transparent; border: none; padding: 0; width: 100%; max-width: 700px; }
    dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    .modal-box { background: #0f151a; border: 1px solid var(--nms-blue); padding: 4px; clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px); }
    .modal-in { background: #151b22; padding: 20px; max-height: 80vh; overflow-y: auto; }
    .cat-btn { background: #222; border: 1px solid #444; color: #888; padding: 5px 10px; cursor: pointer; margin-bottom: 5px; font-size: 10px; }
    .cat-btn.active { background: var(--nms-blue); color: #000; }

    .grid-main { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    @media (max-width: 900px) { .grid-main { grid-template-columns: 1fr; } }
    .hidden { display: none; }
    
    /* --- TOAST --- */
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9); border: 2px solid var(--nms-white);
      padding: 20px 40px; font-size: 20px; font-weight: 900; z-index: 10000;
      pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
  </style>
</head>
<body>

  <div id="boot-screen">
    <div class="boot-logo">ATLAS // SINGULARITY</div>
    <div class="boot-sub">INITIALIZING INTERFACE...</div>
  </div>

  <canvas id="hex-canvas"></canvas>
  <div class="scanlines"></div>
  <div class="vignette"></div>

  <div id="tilt-wrapper">
    <div class="container" id="tilt-target">
      
      <header class="hud">
        <div class="title">
          <h1>SINGULARITY</h1>
          <span class="subtitle" id="ctx-label">STARSHIP // EDIT MODE</span>
        </div>
        <div style="text-align:right; font-size:10px; color:#889bb0;">
           <div><strong>v3.0</strong> STABLE</div>
           <div><strong id="mem-stat">0/64</strong> MEMORY</div>
        </div>
      </header>

      <nav class="tab-rail" id="tabs">
        <button class="tab active" data-id="STARSHIP">STARSHIP</button>
        <button class="tab" data-id="MULTI-TOOL">MULTI-TOOL</button>
        <button class="tab" data-id="FREIGHTER">FREIGHTER</button>
        <button class="tab" data-id="EXOSUIT">EXOSUIT</button>
        <button class="tab" data-id="EXOCRAFT">EXOCRAFT</button>
      </nav>

      <div class="grid-main">
        
        <div class="col-left">
          <section class="panel">
            <div class="panel-content">
              <div class="panel-head">
                <h2><span class="step-deco"></span> DESIGNATION INPUT</h2>
                <div class="toolbar">
                  <button id="undoBtn" class="tool-btn" title="UNDO">â†¶</button>
                  <button id="redoBtn" class="tool-btn" title="REDO">â†·</button>
                  <button id="genBtn" class="tool-btn" title="GENERATE LORE NAME">ðŸŽ²</button>
                </div>
              </div>
              
              <input type="text" id="titleIn" placeholder="ENTER NAME..." maxlength="64" autocomplete="off">
              
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                  <label style="font-size:10px;color:var(--nms-blue);display:block;margin-bottom:5px;">COLOR OVERLAY</label>
                  <select id="colorIn"></select>
                </div>
                <div>
                  <label style="font-size:10px;color:var(--nms-blue);display:block;margin-bottom:5px;">OPTIONS</label>
                  <div style="display:flex; gap:15px; font-size:11px; align-items:center; height:42px;">
                    <label><input type="checkbox" id="colorIconIn" checked> COLOR ICONS</label>
                    <label><input type="radio" name="syn" value="bracket" checked> [ ]</label>
                    <label><input type="radio" name="syn" value="angle"> &lt; &gt;</label>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-content">
              <div class="panel-head"><h2><span class="step-deco"></span> MODULE CONFIGURATION</h2></div>
              <div style="font-size:10px; color:#666; margin-bottom:10px;">DRAG ICONS TO REORDER â€¢ CLICK + TO ADD â€¢ CLICK ICON TO REMOVE</div>
              <div id="slots" class="slot-container"></div>
            </div>
          </section>
        </div>

        <div class="col-right">
          
          <section class="panel">
            <div class="panel-content" style="padding:0; background:#000;">
              <div class="preview-wrapper">
                <div class="preview-box" id="preview"></div>
                <div class="width-bar"><div class="width-fill" id="widthBar"></div></div>
                <div class="width-warn" id="widthWarn">0% VISUAL LOAD</div>
              </div>
              <div style="padding:10px; text-align:center;">
                 <button id="imgBtn" style="background:none; border:1px solid #333; color:#666; cursor:pointer; font-size:10px; padding:5px;">EXPORT IMAGE</button>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-content">
              <div class="panel-head"><h2><span class="step-deco"></span> OPERATIONS</h2></div>
              <div style="display:grid; gap:10px;">
                
                <div class="hold-btn" id="btnCopy">
                  <div class="hold-ring"><svg class="hold-svg" viewBox="0 0 32 32"><circle class="hold-bg" cx="16" cy="16" r="14"></circle><circle class="hold-prog" cx="16" cy="16" r="14"></circle></svg><div style="position:absolute;inset:0;display:grid;place-items:center">C</div></div>
                  <span>HOLD TO COPY RAW</span>
                </div>

                <div class="hold-btn" id="btnSaveEdit">
                  <div class="hold-ring"><svg class="hold-svg" viewBox="0 0 32 32"><circle class="hold-bg" cx="16" cy="16" r="14"></circle><circle class="hold-prog" cx="16" cy="16" r="14"></circle></svg><div style="position:absolute;inset:0;display:grid;place-items:center">J</div></div>
                  <span>HOLD FOR SAVE EDITOR</span>
                </div>

                <div class="hold-btn" id="btnClear">
                  <div class="hold-ring"><svg class="hold-svg" viewBox="0 0 32 32"><circle class="hold-bg" cx="16" cy="16" r="14"></circle><circle class="hold-prog" cx="16" cy="16" r="14"></circle></svg><div style="position:absolute;inset:0;display:grid;place-items:center">X</div></div>
                  <span>HOLD TO RESET</span>
                </div>

              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-content" style="padding:0;">
               <div style="padding:10px 20px; border-bottom:1px solid rgba(255,255,255,0.1)"><h2><span class="step-deco"></span> PRESETS</h2></div>
               <div id="presetList"></div>
            </div>
          </section>
        </div>

      </div>
    </div>
  </div>

  <dialog id="modal">
    <div class="modal-box">
      <div class="modal-in">
        <div class="panel-head">
          <h2>SELECT MODULE</h2>
          <button id="closeModal" style="background:none;border:none;color:var(--nms-red);font-weight:900;cursor:pointer">CLOSE</button>
        </div>
        <div id="catBar" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;"></div>
        <div id="iconGrid" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast">DATA UPLOADED</div>

  <script>
    /* --- DATA: EXPANDED DICTIONARY --- */
    const DB = {
      colors: ["GREEN","RED","STELLAR","FUEL","TRADE","TECHNOLOGY","SPECIAL","RARE","HIGHLIGHT","MISSIONPRIMARY","MISSIONSECOND","FLORA","METAL","EARTH","POS_AVG","NEU_AVG","TITLE_BRIGHT","COMMODITY","VISOR","DARK_TECH"],
      categories: {
        "COMMON": ["NV_SHIP","CARGO","FUEL","STAR","TRADE1","TECH1","UNITS","PLANET","CREATURE","HAZARD"],
        "UI": ["DOT","CLOCK","MISSIONSTART","DIFFICULTY","QUICKSILV","BONES","POWER","GRID"],
        "INV": ["INVSHIP","INVTECH","INVCARGO","SHIP_S","SHIP_A","SHIP_B","SHIP_C"],
        "PLATFORM": ["ICON_GOG","ICON_PS","ICON_STEAM","ICON_XBL","ICON_KBM"],
        "CLASS": ["SCLASS","ACLASS","BCLASS","CCLASS"],
        "NATURE": ["FLORA","WHEAT","PLANT"],
        "COOKING": ["STEW","CAKE","PIE","MEAT","EGG","MILK"]
      },
      emoji: {
        "NV_SHIP":"ðŸš€","CARGO":"ðŸ“¦","FUEL":"â›½","STAR":"â­","TRADE1":"ðŸ’±","TECH1":"ðŸ› ï¸","UNITS":"ðŸ’°","PLANET":"ðŸª","CREATURE":"ðŸ¾","HAZARD":"â˜£ï¸","DOT":"â€¢","CLOCK":"â°","MISSIONSTART":"ðŸŽ¯","DIFFICULTY":"âš ï¸","QUICKSILV":"ðŸª™","BONES":"ðŸ¦´","POWER":"ðŸ”Œ","GRID":"#","INVSHIP":"ðŸš€","INVTECH":"ðŸ”§","INVCARGO":"ðŸŽ’","ICON_GOG":"ðŸŸ¢","ICON_PS":"ðŸ…¿ï¸","ICON_STEAM":"â™¨ï¸","ICON_XBL":"ðŸ•¹ï¸","ICON_KBM":"âŒ¨ï¸","SCLASS":"ðŸŸ¨S","ACLASS":"ðŸŸ©A","BCLASS":"ðŸŸ¦B","CCLASS":"ðŸŸ«C","FLORA":"ðŸŒ¿","WHEAT":"ðŸŒ¾","PLANT":"ðŸŒ²","STEW":"ðŸ²","CAKE":"ðŸ°","PIE":"ðŸ¥§","MEAT":"ðŸ¥©","EGG":"ðŸ¥š","MILK":"ðŸ¥›"
      },
      presets: {
        "STARSHIP": [ {l:"RADIANT PILLAR",t:"RADIANT PILLAR",c:"STELLAR",s:[["NV_SHIP"]]}, {l:"GOLDEN VECTOR",t:"GOLDEN VECTOR",c:"TITLE_BRIGHT",s:[["SCLASS"]]}, {l:"UTOPIA SPEEDER",t:"UTOPIA SPEEDER",c:"SPECIAL",s:[["STAR"]]} ],
        "MULTI-TOOL": [ {l:"ATLAS SCEPTRE",t:"ATLAS SCEPTRE",c:"RED",s:[["TECH1"]]}, {l:"SENTINEL RIFLE",t:"SENTINEL",c:"HIGHLIGHT",s:[["HAZARD"]]} ],
        "FREIGHTER": [ {l:"CAPITAL",t:"CAPITAL SHIP",c:"STELLAR",s:[["STAR"]]} ]
      },
      vocab: {
        adj: ["RADIANT","ANCIENT","CRIMSON","STELLAR","VOID","OMEGA","ALPHA","IRON","GOLDEN","FRACTURED","LOST","ECHOING","SINGULAR","GLASS","OBSIDIAN"],
        noun: ["PILLAR","VECTOR","VULTURE","EAGLE","HORIZON","ECLIPSE","DREAM","SOUL","MIRROR","SHARD","TRAVELER","ENTITY","ANOMALY","ARK","WANDERER"]
      }
    };
    // Flatten icons for easy check
    const ALL_ICONS = Object.values(DB.categories).flat();

    /* --- ENGINE --- */
    const MAX_CHAR = 64;
    const MAX_PIXEL = 700; // Approx width limit in game UI
    let ctx = "STARSHIP";
    
    // State Management with Undo
    let history = [];
    let histPtr = -1;
    let isUndoing = false;

    function createInitialState() {
      return { title: "", color: "", colorIcon: true, syntax: "bracket", slots: [] };
    }

    // DOM
    const el = id => document.getElementById(id);
    const ui = {
      title: el('titleIn'), color: el('colorIn'), check: el('colorIconIn'),
      slots: el('slots'), preview: el('preview'), widthBar: el('widthBar'),
      widthWarn: el('widthWarn'), mem: el('mem-stat'), ctx: el('ctx-label'),
      undo: el('undoBtn'), redo: el('redoBtn')
    };

    /* --- INIT --- */
    window.onload = () => {
      // Populate Color Select
      ui.color.innerHTML = '<option value="">NO OVERLAY</option>';
      DB.colors.forEach(c => {
        const o = document.createElement('option'); o.value=c; o.textContent=c; ui.color.appendChild(o);
      });

      // Event Listeners
      ui.title.addEventListener('input', () => commit());
      ui.color.addEventListener('change', () => commit());
      ui.check.addEventListener('change', () => commit());
      document.querySelectorAll('input[name="syn"]').forEach(r => r.addEventListener('change', () => commit()));
      
      el('undoBtn').onclick = undo;
      el('redoBtn').onclick = redo;
      el('genBtn').onclick = generateLore;
      el('imgBtn').onclick = exportImage;
      
      // Tabs
      document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
          document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
          t.classList.add('active');
          ctx = t.dataset.id;
          ui.ctx.textContent = `${ctx} // EDIT MODE`;
          renderPresets();
          ping('nav');
        }
      });

      // Modal
      el('closeModal').onclick = () => el('modal').close();

      // Buttons
      setupHold('btnCopy', () => { copy(buildRaw()); });
      setupHold('btnSaveEdit', () => { 
        const json = { Name: buildRaw() }; // Simple wrapper
        copy(JSON.stringify(json)); 
        toast("JSON OBJECT COPIED");
      });
      setupHold('btnClear', () => {
        const s = JSON.parse(JSON.stringify(history[histPtr]));
        s.title = ""; s.slots = [];
        pushState(s);
      });

      // Boot State
      pushState(createInitialState());
      renderPresets();
      
      // FX
      initHexCanvas();
      initTilt();
    };

    /* --- STATE LOGIC --- */
    function getCurrent() { return history[histPtr]; }
    
    function pushState(newState) {
      // Slice history if we are in middle
      if (histPtr < history.length - 1) {
        history = history.slice(0, histPtr + 1);
      }
      history.push(JSON.parse(JSON.stringify(newState)));
      histPtr++;
      updateUI();
      checkUndoUI();
    }

    // Called on inputs (Debounced in a real app, here direct)
    function commit() {
      if(isUndoing) return;
      const s = JSON.parse(JSON.stringify(getCurrent()));
      s.title = ui.title.value.toUpperCase().slice(0, MAX_CHAR);
      s.color = ui.color.value;
      s.colorIcon = ui.check.checked;
      s.syntax = document.querySelector('input[name="syn"]:checked').value;
      
      // Ensure slots array matches word count + 1
      const words = s.title.split(' ').filter(x=>x);
      const needed = words.length + 1;
      while(s.slots.length < needed) s.slots.push([]);
      if(s.slots.length > needed) s.slots.length = needed;
      
      pushState(s);
    }

    function undo() {
      if (histPtr > 0) {
        histPtr--;
        isUndoing = true;
        restore(history[histPtr]);
        isUndoing = false;
        checkUndoUI();
        ping('nav');
      }
    }

    function redo() {
      if (histPtr < history.length - 1) {
        histPtr++;
        isUndoing = true;
        restore(history[histPtr]);
        isUndoing = false;
        checkUndoUI();
        ping('nav');
      }
    }

    function restore(s) {
      ui.title.value = s.title;
      ui.color.value = s.color;
      ui.check.checked = s.colorIcon;
      document.querySelectorAll('input[name="syn"]').forEach(r => r.checked = (r.value === s.syntax));
      updateUI();
    }

    function checkUndoUI() {
      ui.undo.disabled = histPtr <= 0;
      ui.redo.disabled = histPtr >= history.length - 1;
    }

    /* --- RENDERING --- */
    function updateUI() {
      const s = getCurrent();
      const words = s.title.split(' ').filter(x=>x);
      const raw = buildRaw();
      
      // 1. Render Slots (Drag & Drop)
      ui.slots.innerHTML = "";
      for(let i=0; i<s.slots.length; i++) {
        // Slot Div
        const slot = document.createElement('div');
        slot.className = "slot";
        slot.draggable = true;
        slot.dataset.idx = i;
        
        // Drag Events
        slot.addEventListener('dragstart', e => {
          e.dataTransfer.setData('idx', i);
          slot.classList.add('dragging');
        });
        slot.addEventListener('dragend', () => slot.classList.remove('dragging'));
        slot.addEventListener('dragover', e => { e.preventDefault(); slot.style.borderColor = "#fff"; });
        slot.addEventListener('dragleave', () => slot.style.borderColor = "");
        slot.addEventListener('drop', e => {
          e.preventDefault();
          const from = e.dataTransfer.getData('idx');
          const to = i;
          if(from !== "" && from != to) {
             // Swap Logic (only within array bounds)
             const temp = s.slots[from];
             s.slots[from] = s.slots[to];
             s.slots[to] = temp;
             pushState(s);
             ping('ok');
          }
        });
        slot.onclick = () => openModal(i);

        // Content
        if(s.slots[i] && s.slots[i].length > 0) {
          slot.innerHTML = `<span class="slot-img">${DB.emoji[s.slots[i][0]] || "ðŸ’ "}</span>`;
          slot.style.borderColor = "var(--nms-orange)";
        } else {
          slot.innerHTML = `<span class="slot-add">+</span>`;
        }
        ui.slots.appendChild(slot);

        // Word Chip
        if(i < words.length) {
          const chip = document.createElement('div');
          chip.className = "word-chip";
          chip.textContent = words[i];
          ui.slots.appendChild(chip);
        }
      }

      // 2. Preview
      renderPreview(s, words);
      
      // 3. Stats
      ui.mem.textContent = `${s.title.length}/${MAX_CHAR}`;
    }

    function renderPreview(s, words) {
      const box = ui.preview;
      box.innerHTML = "";
      const colorCSS = getColorCSS(s.color);
      
      // Helper for span
      const mk = (txt, colorize) => {
        const sp = document.createElement('span');
        sp.textContent = txt + " "; // Add spacing
        if(colorize && s.color) {
          sp.style.color = colorCSS;
          sp.style.textShadow = `0 0 5px ${colorCSS}`;
        }
        return sp;
      };

      for(let i=0; i<s.slots.length; i++) {
        // Icon
        if(s.slots[i] && s.slots[i].length > 0) {
          box.appendChild(mk((DB.emoji[s.slots[i][0]] || "ðŸ’ "), s.colorIcon));
        }
        // Word
        if(i < words.length) {
          box.appendChild(mk(words[i], true));
        }
      }

      // 4. Width Calculation
      // Create Canvas to measure
      const cv = document.createElement('canvas');
      const cx = cv.getContext('2d');
      cx.font = "900 24px 'Century Gothic', sans-serif";
      const width = cx.measureText(box.textContent).width * 1.5; // 1.5 approx spacing factor
      const pct = Math.min(100, (width / MAX_PIXEL) * 100);
      
      ui.widthBar.style.width = pct + "%";
      ui.widthBar.style.background = pct > 90 ? "red" : "var(--nms-blue)";
      ui.widthWarn.textContent = `${Math.round(pct)}% VISUAL LOAD`;
      ui.widthWarn.style.color = pct > 90 ? "red" : "#666";
    }

    /* --- LOGIC HELPERS --- */
    function buildRaw() {
      const s = getCurrent();
      const words = s.title.split(' ').filter(x=>x);
      const angle = s.syntax === 'angle';
      const open = s.color ? (angle ? `<${s.color}>` : `[${s.color}]`) : "";
      const close = s.color ? (angle ? `</>` : `[//]`) : "";
      const icon = t => angle ? `<IMG>${t}<>` : `[I_IMG:${t}]`;
      
      let out = "";
      if(s.colorIcon) {
        if(s.color) out += open;
        for(let i=0; i<s.slots.length; i++) {
          if(s.slots[i]) s.slots[i].forEach(x => out += icon(x));
          if(i < words.length) out += words[i] + " ";
        }
        // Trim trailing space
        out = out.trim(); 
        if(s.color) out += close;
      } else {
         for(let i=0; i<s.slots.length; i++) {
          if(s.slots[i]) s.slots[i].forEach(x => out += icon(x));
          if(i < words.length) {
            out += (s.color ? open+words[i]+close : words[i]) + " ";
          }
        }
      }
      return out.trim();
    }

    function generateLore() {
      const s = JSON.parse(JSON.stringify(getCurrent()));
      const adj = DB.vocab.adj[Math.floor(Math.random()*DB.vocab.adj.length)];
      const noun = DB.vocab.noun[Math.floor(Math.random()*DB.vocab.noun.length)];
      const name = `THE ${adj} ${noun}`;
      s.title = name;
      
      // Random Color
      if(Math.random() > 0.3) {
        s.color = DB.colors[Math.floor(Math.random()*DB.colors.length)];
      }
      
      // Reset slots
      s.slots = [];
      const w = name.split(' ').length;
      for(let i=0; i<=w; i++) s.slots.push([]);
      
      pushState(s);
      toast("LORE GENERATED");
      ping('ok');
    }

    function exportImage() {
       const box = ui.preview;
       const cv = document.createElement('canvas');
       cv.width = 600; cv.height = 150;
       const cx = cv.getContext('2d');
       
       // BG
       cx.fillStyle = "#0b1e2d"; cx.fillRect(0,0,600,150);
       // Border
       cx.strokeStyle = "#44c7ff"; cx.lineWidth = 4; cx.strokeRect(10,10,580,130);
       
       // Text
       cx.font = "900 30px 'Century Gothic', sans-serif";
       cx.textAlign = "center"; cx.textBaseline = "middle";
       cx.fillStyle = "#fff";
       if(getCurrent().color) cx.fillStyle = getColorCSS(getCurrent().color);
       
       cx.fillText(box.textContent, 300, 75);
       
       // Open
       const img = cv.toDataURL("image/png");
       const w = window.open("");
       w.document.write('<img src="'+img+'" style="border:1px solid #555"/>');
    }

    /* --- MODAL --- */
    let modIdx = -1;
    function openModal(idx) {
      modIdx = idx;
      renderIconGrid("COMMON"); // Default
      el('modal').showModal();
    }
    
    function renderIconGrid(cat) {
      const grid = el('iconGrid');
      const bar = el('catBar');
      grid.innerHTML = ""; bar.innerHTML = "";
      
      // Categories
      Object.keys(DB.categories).forEach(k => {
        const b = document.createElement('button');
        b.className = "cat-btn" + (k===cat ? " active":"");
        b.textContent = k;
        b.onclick = () => renderIconGrid(k);
        bar.appendChild(b);
      });
      
      // Icons
      DB.categories[cat].forEach(tok => {
        const d = document.createElement('div');
        d.style.cssText = "width:60px;height:60px;background:#000;border:1px solid #333;display:grid;place-items:center;cursor:pointer;";
        d.innerHTML = `<div style="font-size:20px">${DB.emoji[tok]||"ðŸ’ "}</div><div style="font-size:9px;color:#666">${tok}</div>`;
        d.onclick = () => {
           const s = JSON.parse(JSON.stringify(getCurrent()));
           // Toggle icon in slot (Max 1 for UI cleanliness, can be array in logic)
           if(s.slots[modIdx][0] === tok) s.slots[modIdx] = [];
           else s.slots[modIdx] = [tok];
           pushState(s);
           el('modal').close();
           ping('ok');
        };
        grid.appendChild(d);
      });
    }

    function renderPresets() {
      const list = el('presetList');
      list.innerHTML = "";
      (DB.presets[ctx]||[]).forEach(p => {
        const d = document.createElement('div');
        d.style.cssText = "padding:10px 20px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;display:flex;justify-content:space-between;";
        d.innerHTML = `<span>${p.l}</span><strong style="color:var(--nms-orange)">// LOAD</strong>`;
        d.onclick = () => {
           const s = createInitialState();
           s.title = p.t; s.color = p.c; s.slots = p.s;
           pushState(s);
           toast("PRESET LOADED");
           ping('ok');
        };
        list.appendChild(d);
      });
    }

    /* --- UTILS --- */
    function getColorCSS(name) {
      // Simplified map
      const map = {GREEN:"#22c55e",RED:"#ef4444",STELLAR:"#facc15",FUEL:"#f59e0b",TRADE:"#10b981",TECHNOLOGY:"#818cf8",SPECIAL:"#f472b6",RARE:"#e879f9",HIGHLIGHT:"#67e8f9"};
      return map[name] || "#fff";
    }
    
    function copy(txt) {
      navigator.clipboard.writeText(txt);
      toast("DATA COPIED");
      ping('ok');
    }

    function toast(msg) {
      const t = el('toast');
      t.textContent = msg; t.style.opacity = 1;
      setTimeout(() => t.style.opacity = 0, 1500);
    }

    function setupHold(id, cb) {
      const btn = el(id);
      const c = btn.querySelector('.hold-prog');
      const ring = 88; 
      let t, start;
      
      const reset = () => {
        clearTimeout(t);
        c.style.transition = "stroke-dashoffset 0.2s";
        c.style.strokeDashoffset = ring;
      };
      
      const run = (e) => {
        e.preventDefault();
        c.style.transition = "stroke-dashoffset 0.8s linear";
        c.style.strokeDashoffset = 0;
        t = setTimeout(() => { cb(); reset(); }, 800);
      };
      
      btn.onmousedown = run; btn.ontouchstart = run;
      btn.onmouseup = reset; btn.onmouseleave = reset; btn.ontouchend = reset;
    }

    /* --- AUDIO --- */
    let actx;
    function ping(t) {
      if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)();
      const o = actx.createOscillator();
      const g = actx.createGain();
      const now = actx.currentTime;
      o.connect(g); g.connect(actx.destination);
      
      if(t==='ok') {
        o.type = 'sine';
        o.frequency.setValueAtTime(800, now);
        o.frequency.exponentialRampToValueAtTime(400, now+0.1);
        g.gain.setValueAtTime(0.1, now);
        g.gain.linearRampToValueAtTime(0, now+0.1);
        o.start(); o.stop(now+0.1);
      } else {
        o.type = 'triangle';
        o.frequency.setValueAtTime(1200, now);
        g.gain.setValueAtTime(0.05, now);
        g.gain.linearRampToValueAtTime(0, now+0.05);
        o.start(); o.stop(now+0.05);
      }
    }

    /* --- FX --- */
    function initHexCanvas() {
      const c = el('hex-canvas');
      const x = c.getContext('2d');
      let w,h;
      const rs = () => { w=c.width=innerWidth; h=c.height=innerHeight; };
      window.onresize = rs; rs();
      
      // Hex Grid Logic
      const draw = () => {
        x.clearRect(0,0,w,h);
        x.strokeStyle = "rgba(68, 199, 255, 0.1)";
        const s = 40;
        const t = Date.now()*0.0005;
        for(let cy=0; cy<h+s; cy+=s*0.86) {
           for(let cx=0; cx<w+s; cx+=s*3) {
             const off = (Math.floor(cy/(s*0.86))%2)*s*1.5;
             const px = cx + off;
             const a = (Math.sin(px*0.01 + t) + 1) * 0.1;
             x.fillStyle = `rgba(68, 199, 255, ${a})`;
             x.beginPath();
             for(let i=0; i<6; i++) x.lineTo(px + s*Math.cos(i*Math.PI/3), cy + s*Math.sin(i*Math.PI/3));
             x.fill(); x.stroke();
           }
        }
        requestAnimationFrame(draw);
      };
      draw();
    }
    
    function initTilt() {
      const t = el('tilt-target');
      document.onmousemove = e => {
         const x = (e.clientX/innerWidth - 0.5) * 1; // deg
         const y = (e.clientY/innerHeight - 0.5) * 1;
         t.style.transform = `rotateY(${x}deg) rotateX(${-y}deg)`;
      };
    }

  </script>
</body>
</html>
